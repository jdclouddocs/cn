# 编排模板

## 模板语法说明-模板结构说明

模板是一个 JSON 格式的文本文件，使用 UTF8 编码。模板用于创建资源栈，是描述基础设施和架构的蓝图。模板编辑者在模板中定义资源和配置细节，并说明资源间的依赖关系。

### JSON
下面的示例显示 JSON 格式的模板片段。

```
{
  "JDCLOUDTemplateFormatVersion" : "2018-10-01",

  "Description" : "模板描述信息，可用于说明模板的适用场景、架构说明等。",

  "Parameters" : {
      // 定义创建资源栈时，用户可以定制化的参数。
  },

  "Mappings" : {
      // 定义映射信息表，映射信息是一种多层的 Map 结构。
  },

  "Conditions" : {
      // 使用内部条件函数定义条件。这些条件确定何时创建关联的资源。
  },

  "Resources" : {
      // 所需资源的详细定义，包括资源间的依赖关系、配置细节等。
  },

  "Outputs" : {
      // 用于输出一些资源属性等有用信息。可以通过 API 或控制台获取输出的内容。
  }
}
```

### 模板部分
模板包含几个主要部分。Resources 和 Format Version 部分是必需部分。模板中的某些部分可以任何顺序显示。但是，在您构建模板时，使用以下列表的逻辑顺序可能会很有用，因为一个部分中的值可能会引用上一个部分中的值。列表简要概述了每个部分。

#### Format Version（必选）
JDRO支持的模板版本号，当前版本号：2018-10-01

#### Description（可选）
一个描述模板的文本字符串，对模板进行详细描述。

#### Parameters（可选）
定义创建资源栈时，模板用户可以定制化的参数。在运行时 (创建或更新堆栈时) 传递到模板。您可在模板的 Resources 和 Outputs 部分中引用定义的这些参数。使用参数可以增强模板的灵活性，提高复用性。

更多详细信息，请参见 [参数（Parameters）](#参数parameters)。

#### Mappings（可选）
可用来指定条件参数值的密钥和关键值的映射，与查找表类似。您可通过使用 Resources 和 Outputs 部分中的 Fn::FindInMap 内部函数将键与相应的值匹配。

更多详细信息，请参见 [映射（Mappings）](#映射mappings)。

#### Conditions（可选）
Conditions 使用 Fn::And、Fn::Or、Fn::Not、Fn::Equals 等定义条件。在创建或更新资源栈时，系统先计算模板中的所有条件，然后再创建资源。创建与 true 条件关联的所有资源，忽略与 false 条件关联的所有资源。

更多详细信息，请参见 [条件（Conditions）](#条件conditions)。

#### Resources（可选）
用于详细定义使用该模板创建的资源栈所包含的资源，包括资源间的依赖关系、配置细节等。

更多详细信息，请参见 [资源（Resources）](#资源resources)。

#### Outputs（可选）
用于输出一些资源属性等有用信息。可以通过 API 或控制台获取输出的内容。

更多详细信息，请参见 [输出（Outputs）](#输出outputs)。

## 功能2：模板语法说明-基本语法

### 参数（Parameters）
在创建模板时，使用参数（Parameters）可提高模板的灵活性和可复用性。创建资源栈时，可根据实际情况，替换模板中的某些参数值。

#### 在模板中定义参数

以下示例声明名为 InstanceTypeParameter 的参数。利用此参数，您可以为堆栈指定实例类型以在创建或更新堆栈时使用。

请注意，InstanceTypeParameter 在此示例中具有默认值 g.n2.medium。


```
"Parameters" : {
  "InstanceTypeParameter" : {
    "Type" : "String",
    "Default" : "g.n2.medium",
    "AllowedValues" : ["g.n2.medium", "g.n2.large", "g.n2.xlarge"],
    "Description" : "选择实例类型，默认为 g.n2.medium，可选值为g.n2.medium, g.n2.large, g.n2.xlarge"
  }
}
```


#### 在模板中引用参数

您使用 Ref 内部函数来引用某个参数，使用该参数的值来预置堆栈。您在模板的 Resources 和 Outputs 部分中引用该参数。

在以下示例中，vm实例资源的 InstanceType 属性引用了 InstanceTypeParameter 参数值：

```
"MyInstance" : {
  "Type" : "JDCLOUD::VM::Instance",
  "Properties" : {
    "InstanceType" : { "Ref" : "InstanceTypeParameter" },
    "ImageId" : "img-wcewkxc5c1"
  }
}
```

#### 参数的一般要求

使用参数时存在以下要求：

* 一个 JDRO 模板中最多可包含 60 个参数。

* 必须为每个参数提供一个逻辑名称 (也称为逻辑 ID)，该名称必须是字母数字，并且在模板内的所有逻辑名称中必须是唯一的。

* 必须向每个参数分配一个 JDRO 支持的参数类型。有关更多信息，请参阅类型。

* 必须向每个参数分配一个值，也可以定义默认值。

#### 语法

每个参数由参数名称和参数属性组成。

参数名称必须为字母数字，并且在同一个模板中不能与其它参数名称重复。

参数属性列表：

|属性|必须|描述|
|:--|:--|:--|
|Type|是|参数的数据类型。<br>JDRO目前支持以下参数类型：<br><br>**1）String**<br>字符串。如："ecs.s1.medium"。<br><br>**2）Number**<br>整数或浮点数。如：3.14。<br><br>**3）CommaDelimitedList**<br>一组用逗号分隔的字符串或数字，可通过 Fn::Select 函数索引值。如："80, foo, bar"。<br><br>**4）List\<Number\>**<br>一组用逗号分隔的整数或浮点数。JDRO 将参数值验证为数字，但当您在模板中的其他位置使用该参数时（例如，通过使用 Ref 内部函数），该参数值将变成字符串列表。例如，用户可指定 "80,20"，并且 Ref 将生成 ["80","20"]。<br><br>**5）Boolean**<br>一个布尔值。如：true 或者 false。<br><br>**6）JDRO特定的参数类型**<br>JDRO 的特殊值，例如 vm 镜像。有关更多信息，请参阅 [JDRO 特定的参数类型](#JDROsptype)。|
|Default|否|在创建资源栈时，如果用户没有传入指定值，资源编排服务会检查模板中是否有定义默认值。如果有定义默认值，则使用默认值，否则报错。|
|NoEcho|否|当调用查询资源栈时，是否输出参数值。如果将值设置为 true，则只输出星号 (******)。|
|AllowedValues|否|包含参数允许值的列表。|
|AllowedPattern|否|一个正则表达式，用于检查用户输入的字符串类型的参数是否匹配。如果用户输入的不是字符串类型，则报错。|
|MinLength|否|一个整数值，允许 String 类型使用的字符的最小数目。|
|MaxLength|否|一个整数值，允许 String 类型使用的字符的最大数目。|
|MinValue|否|一个数字值，允许 Number 类型使用的最小数字值。|
|MaxValue|否|一个数字值，允许 Number 类型使用的最大数字值。|
|Description|否|描述参数的字符串。|
|ConstraintDescription|否|违反该参数约束条件时，说明该约束条件的字符串。|

#### JDRO 特定的参数类型
为了方便用户，定义一些特定参数类型，若用户在模板中设置了这些参数类型，则在创建资源栈时，该类型的参数对应的值，以下拉列表框列出用户对应区域下的资源。支持的特定参数类型如下：

| 类型                              | 说明                                                                                        |
| --------------------------------- | ------------------------------------------------------------------------------------------- |
| JDClOUD:::AvailabilityZone::Name  | 列出当前地域下的可用区                                                                      |
| JDClOUD::VM::PublicImage::Name    | 列出当前地域下可用的公共镜像                                                                |
| JDClOUD:::VM::PrivateImage:::Name | 列出当前地域下可用的私有镜像                                                                |
| JDClOUD:::VM::SharedImage:::Name  | 列出当前地域下可用的共享镜像                                                                |
| JDClOUD:::VM::Instance::Id        | 列出当前地域下的云主机，下拉列表中展示格式为“名称(ID)”,例如：VM_test(i-nwyuh3eben)        |
| JDClOUD:::VM::Disk::Id            | 列出当前地域下的云硬盘，下拉列表中展示格式为“名称(ID)”,例如：disk_test(vol-8i4mv87d48)    |
| JDClOUD:::VM::KeyPair::KeyName    | 列出当前地域下的密钥名称                                                                    |
| JDClOUD::SecurityGroup::GroupName | 列出当前地域下的安全组名称                                                                  |
| JDClOUD::VPC::VPC::Id             | 列出当前地域下的子网，下拉列表中展示格式为“名称(ID)”,例如：Subnet_test(subnet-d6x9i2t4i1) |


### 资源（Resources）

资源（Resources） 用于描述资源栈中每个资源的属性和资源之间依赖关系。一个 Resources 可以被其他资源和 Outputs 所引用。

#### 语法

Resources 由资源逻辑 ID 和资源描述组成。请参见以下 Resources 的语法结构示例代码段：

```
"Resources" : {
    "resource1 LogicID" : {
        "Type" : "资源类型",
        "Condition": "是否创建此资源的条件"，
        "Properties" : {
            资源属性描述
        }
        "DeletionPolicy":"资源的删除策略",
        "DependsOn":["资源依赖列表"],
    },
    "resource2 LogicID" : {
        "Type" : "资源类型",
        "Condition": "是否创建此资源的条件"，
        "Properties" : {
            资源属性描述
        }
    }
}
```

#### 资源逻辑ID

逻辑 ID 必须为字母数字（a-z、 A-Z 和 0-9），并且在模板中具有唯一性。使用逻辑名称在模板的其他部分中引用资源。

#### 资源类型（Type）

资源类型表示正在声明的资源的类型。例如，JDCLOUD::VM::Instance 表示京东云vm实例。有关 JDRO 支持的所有资源类型列表和详细信息，请参见 [资源类型列表](#)。

#### 创建条件（Condition）
在模板中，使用 Condition 属性可以指定是否需要创建此资源。只有 Condition 所指定的条件值为 true 时，才会创建此资源。

如以下代码段所示，设置根据 EnvType 参数值决定是否给 vm 实例绑定 弹性ip 。

```
{
    "JDCLOUDTemplateFormatVersion": "2018-10-01",
    "Parameters": {
        "EnvType": {
            "Description": "Environment type.",
            "Default": "test",
            "Type": "String",
            "AllowedValues": [
                "prod",
                "test"
            ],
            "ConstraintDescription": "must specify prod or test."
        }
    },
    "Mappings": {
        "AZInfo": {
            "cn-north-1": {
                "az1": "cn-north-1a",
                "az2": "cn-north-1b"
            },
            "cn-east-1": {
                "az1": "cn-east-1a",
                "az2": "cn-east-1b"
            },
            "cn-east-2": {
                "az1": "cn-east-2a",
                "az2": "cn-east-2b"
            },
            "cn-south-1": {
                "az1": "cn-south-1a",
                "az2": "cn-south-1b"
            }
        }
    },
    "Conditions": {
        "CreateProdResources": {
            "Fn::Equals": [
                {
                    "Ref": "EnvType"
                },
                "prod"
            ]
        }
    },
    "Resources": {
        "MyInstance": {
            "Type": "JDCLOUD::VM::Instance",
            "Properties": {
                "AZ": {
                    "Fn::FindInMap": [
                        "AZInfo",
                        {
                            "Ref": "JDCLOUD::Region"
                        },
                        "az1"
                    ]
                }
            }
        },
        "MyElasticIp": {
            "Type": "JDCLOUD::VPC::ElasticIp",
            "Condition": "CreateProdResources",
            "Properties": {
                "ElasticIpSpec": {
                    "BandwidthMbps": "1",
                    "Provider": "bgp"
                }
            }
        },
        "MyAssociateElasticIp": {
            "Type": "JDCLOUD::VPC::AssociateElasticIp",
            "Condition": "CreateProdResources",
            "Properties": {
                "InstanceId": {
                    "Ref": "MyInstance"
                },
                "InstanceType": "vm",
                "ElasticIpId": {
                    "Ref": "MyElasticIp"
                }
            }
        }
    },
    "Outputs": {
        "ElasticIpAddress": {
            "Value": {
                "Fn: : GetAtt": [
                    "MyInstance",
                    "ElasticIpAddress"
                ]
            },
            "Condition": "CreateProdResources"
        }
    }
}
```


#### 资源属性（Properties)

资源属性是为资源指定的附加选项。例如，必须为每个京东云 vm 实例指定一个 Image ID。

```
"Resources" : {
  "MyInstance" : {
    "Type" : "JDCLOUD::VM::Instance",
    "Properties" : {
      "ImageId" : "img-wcewkxc5c1"
    }
  }
}
```
如果资源不需要声明属性，可忽略该资源的属性部分。

属性值可以是文本字符串、字符串列表、布尔值、引用参数、或者函数返回值。如果属性值为文本字符串，该值会被双引号 ("") 括起来。如果属性值为任一类型的字符串列表，则会被中括号 ([ ]) 括起来。如果值为内部函数或引用的参数，则会被大括号 ({ }) 括起来。当您将文字、列表、引用参数、和函数返回值合并起来取值时，上述规则适用。

例如：
```
"Properties" : {
    "String" : "one-string-value",
    "Number" : 123,
    "LiteralList" : [ "first-value", "second-value" ],
    "Boolean" : true,
    "ReferenceForOneValue" :  { "Ref" : "MyLogicalResourceName" } ,
    "FunctionResultWithFunctionParams" : {
        "Fn::Join" : [ "%", [ "Key=", { "Ref" : "MyParameter" } ] ] }
}
```

#### 删除策略（DeletionPolicy）

在模板中，设置 DeletionPolicy 属性，可以声明在资源栈被删除时保留某个资源。可选值为Delete（删除）、Retain（保留）、Snapshot（快照）。

例如，设置在资源栈删除时，保留 vm 实例。可按照如下代码段进行声明：

```
"Resources" : {
  "MyInstance" : {
    "Type" : "JDCLOUD::VM::Instance",
    "Properties" : {
      "ImageId" : "img-wcewkxc5c1"
    },
    "DeletionPolicy" : "Retain"
  }
}
```

#### 资源依赖（DependsOn）

在模板中，设置 DependsOn 属性，可以指定特定资源紧跟着另一个资源后创建。为某个资源添加 DependsOn 属性后，该资源仅在 DependsOn 属性中指定的资源之后创建。

如以下代码段所示，MyInstance 将在 MyDBInstance 创建成功后才开始创建：

```
{
    "JDCLOUDTemplateFormatVersion": "2018-10-01",
    "Resources": {
        "MyDBInstance": {
            "Type": "JDCLOUD::RDS::DBInstance",
            "Properties": {
            }
        },
        "MyInstance": {
            "Type": "JDCLOUD::VM::Instance",
            "DependsOn": "MyDBInstance"
            "Properties": {
            }
        },
    }
}
```


### 输出（Outputs）

在输出（Outputs）中，定义在调用查询堆栈接口时返回的值。例如，定义 vm 实例 privateIpAddress 的输出，然后可在调用查询堆栈的接口时，查看该实例的内网ip地址。

#### 语法

Outputs 部分包含键名称 Outputs，后跟一个空格和一个冒号。您最多可在一个模板中声明 60 个输出。例如：

```
"Outputs" : {
  "output1 LogicID" : {
    "Description" : "输出的描述",
    "Condition": "是否输出此资源属性的条件",
    "Value" : "输出值的表达式"
  },
  "output2 LogicID" : {
    "Description" : "输出的描述",
    "Condition": "是否输出此资源属性的条件",
    "Value" : "输出值的表达式"
  }
}
```

#### 输出逻辑 ID
当前输出的标识符。逻辑 ID 必须为字母数字（a-z、A-Z 和 0-9），并且在模板中具有唯一性。

#### Description（可选）
用于描述输出值的 String 类型。

#### Value（必需）
在调用查询堆栈接口时，返回的属性值。输出值可以包括文字值、参数引用、伪参数、映射值或内部函数。

#### Condition（可选）
使用 Condition 属性可以指定是否需要创建某个资源和输出资源的信息。当 Condition 所指定的条件值为 true 时，才创建此资源和输出资源信息。

例如：
```
{
    "Outputs": {
        "ElasticIpAddress": {
            "Value": "ElasticIpAddress value",
            "Condition": "CreateProdResources"
        }
    }
}
```


### 函数（Functions）

JDRO 提供多个内置函数帮助您管理您的堆栈。可以在模板中资源（Resources) 和输出 (Outputs) 时使用。

[Fn::Base64](#fnbase64)

[Fn::FindInMap](#fnfindinmap)

[Fn::GetAtt](#fngetatt)

[Fn::Join](#fnjoin)

[Fn::Select](#fnselect)

[Fn::Split](#fnsplit)

[Fn::Sub](#fnsub)

[Ref](#ref)

[Fn::And](#fnand)

[Fn::Equals](#fnequals)

[Fn::If](#fnif)

[Fn::Not](#fnnot)

[Fn::Or](#fnor)

---

### Fn::Base64
内部函数 Fn::Base64 返回输入字符串的 Base64 编码结果。

#### 声明
```
{ "Fn::Base64" : valueToEncode }
```

#### 参数

**valueToEncode**：转换成 Base64 的字符串。

#### 返回值
用 Base64 表示方法的原始字符串。

### 示例
```
{ "Fn::Base64" : "hello world" }
```

---

### Fn::FindInMap
内部函数 Fn::FindInMap 返回与 Mappings 声明的双层映射中的键对应的值。

#### 声明
```
{ "Fn::FindInMap" : [ "MapName", "TopLevelKey", "SecondLevelKey"] }
```

#### 参数

**MapName**：Mappings 部分中所声明映射的逻辑名称，包含密钥和值。

**TopLevelKey**：顶层密钥名称。其值是一个键/值对列表。

**SecondLevelKey**：第二层密钥的名称，设置为分配给 TopLevelKey 的列表中的其中一个密钥。

#### 返回值
分配给 SecondLevelKey 的值。

### 示例
```
{
  ...
  "Mappings" : {
    "RegionMap" : {
      "cn-north-1" : { "32" : "img-wcewkxc5c1", "64" : "img-wcewkxc5c2" },
      "cn-west-1" : { "32" : "img-wcewkxc5c1", "64" : "img-wcewkxc5c2" },
      "cn-west-2" : { "32" : "img-wcewkxc5c1", "64" : "img-wcewkxc5c2" },
      "cn-south-1" : { "32" : "img-wcewkxc5c1", "64" : "img-wcewkxc5c2" }
    }
  },

  "Resources" : {
     "MyInstance" : {
        "Type" : "JDCLOUD::VM::Instance",
        "Properties" : {
           "ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "JDCLOUD::Region" }, "32"]},
           "InstanceType" : "g.n2.medium"
        }
     }
 }
}
```

---

### Fn::GetAtt
内部函数 Fn::GetAtt 返回模板中的资源的属性值。

#### 声明
```
{ "Fn::GetAtt" : [ "logicalNameOfResource", "attributeName" ] }
```

#### 参数
**logicalNameOfResource**：资源的逻辑ID。

**attributeName**：您想要获得其值的资源特定属性名称。有关该资源类型之可用属性的详细信息，请参阅资源的引用页面。

#### 返回值
属性值。

### 示例
```
{
    "Fn::GetAtt" : [ "MyInstance" , "PrivateIpAddress" ]
}
```

---

### Fn::Join
内部函数 Fn::Join 将一组值连接起来，用特定分隔符隔开。

#### 声明
```
{ "Fn::Join" : [ "delimiter", [ "string1", "string2", ... ]] }
```

#### 参数
**delimiter**：分隔符。分隔符可以为空，这样就将所有的值直接连接起来。

**[ "string1", "string2", ... ]**：被连接起来的值列表示例。

#### 返回值
被连接起来的字符串。

### 示例
```
{
    "Fn::Join" : [ ",", [ "a", "b", "c" ] ]
}
```
返回："a,b,c"。

---

### Fn::Select
内部函数 Fn::Select 通过索引返回数据元列表中的单个数据元。

#### 声明
```
{"Fn::Select" : [ "index", [ "value1", "value2", ... ] ]}
```

#### 参数
index：待检索数据元的索引。0 到 N-1 之间的某个值（其中 N 代表阵列中元素的数量）

#### 返回值
选定的数据元。

### 示例
```
{ "Fn::Select" : [ "1", [ "apples", "grapes", "oranges", "mangoes" ] ] }
```
返回："grapes"。

---

### Fn::Split
内部函数 Fn::Split 通过指定分隔符对字符串进行切片，并返回所有切片组成的列表。

#### 声明
```
{"Fn::Split" : [ "delim",  "original_string" ]}
```

#### 参数
**delim**：分隔符, 例如: ‘,’，’;’，’\n’，’\t’ 等。

**original_string**：将要被切片的字符串。

#### 返回值
返回切片后所有字符串组成的列表。


### 示例
```
{"Fn::Split": [";", "foo; bar; achoo"]}
```
返回：["foo", " bar", "achoo "]。

---

### Fn::Sub
内部函数 Fn::Sub 将输入字符串中的变量替换为您指定的值。

#### 声明
```
{ "Fn::Sub" : [ "", { Var1Name: Var1Value, Var2Name: Var2Value } ] }
```

#### 参数

**String**：一个带变量的字符串，在运行时会将这些变量替换为其关联的值。以 ${MyVarName} 形式编写变量。变量可以是模板参数名、资源逻辑 ID、资源属性或键值映射中的变量。如果您仅指定模板参数名、资源逻辑 ID 和资源属性，则不要指定键值映射。

如果您指定模板参数名或资源逻辑 ID（例如 ${InstanceTypeParameter}），则返回的值与您使用 Ref 内部函数时返回的值相同。如果您指定资源属性（例如 ${MyInstance.PublicIp}），则返回的值与您使用 Fn::GetAtt 内部函数时返回的值相同。


**VarName**：String 参数中包含的变量的名称。

**VarValue**：在运行时要将关联的变量名称替换为的值。


#### 返回值
返回原始字符串，并替换所有变量的值。

### 示例

#### 带映射的 Fn::Sub
```
{ "Fn::Sub": [ "www.${Domain}", { "Domain": {"Ref" : "RootDomainName" }} ]}
```

#### 不带映射的 Fn::Sub

```
{ "Fn::Sub": "${JDCLOUD::Region}:${JDCLOUD::StackName}:vpc/${vpc}" }
```

---

### Ref
内部函数 Ref 返回指定参数或资源的值。

如果指定参数是资源逻辑ID，则返回资源的值。否则系统将认为指定参数是参数，将尝试返回参数的值。

#### 声明
```
{
    "Ref" : "LogicalID"
}
```

#### 参数
**LogicalID**：要引用的资源或参数的逻辑ID。

#### 返回值
资源的值或者参数的值。

* 它在您指定参数逻辑名称时返回参数值。

* 在您指定资源的逻辑名称时，它会返回一个您一般用于引用该资源的值，如物理 ID。

### 示例
```
{
        "JDCLOUDTemplateFormatVersion": "2018-10-01",
        "Parameters": {
            "AddressPrefix": {
                "ConstraintDescription": "Need give an exact CIDR.",
                "Default": "10.0.0.0/16",
                "Description": "Need give an exact CIDR",
                "Type": "String"
            },
            "SubnetName": {
                "ConstraintDescription": "No overwritten Info.",
                "Default": "MySubnet",
                "Description": "My Subnet Name",
                "MaxLength": "32",
                "MinLength": "1",
                "Type": "String"
            },
            "VPCName": {
                "ConstraintDescription": "No overwritten Info.",
                "Default": "MyVPC",
                "Description": "My VPC Name",
                "MaxLength": "32",
                "MinLength": "1",
                "Type": "String"
            }
        },
        "Resources": {
            "MySubnet": {
                "Properties": {
                    "AddressPrefix": {
                        "Ref": "AddressPrefix"
                    },
                    "SubnetName": {
                        "Ref": "SubnetName"
                    },
                    "VpcId": {
                        "Ref": "MyVPC"
                    }
                },
                "Type": "JDCLOUD::VPC::Subnet"
            },
            "MyVPC": {
                "Properties": {
                    "VpcName": {
                        "Ref": "VPCName"
                    }
                },
                "Type": "JDCLOUD::VPC::VPC"
            }
        }
    }
```

---

### Fn::And
代表 AND 运算符，最少包含两个条件。如果所有指定条件计算为 true，则返回 true；如果任意条件计算为 false，则返回 false。

#### 声明
```
{"Fn::And": ["condition", {...}]}
```

#### 参数

**condition**：计算为 true 或 false 的条件。

#### 返回值
true 或 false。

### 示例
```
{
  "JDCLOUDTemplateFormatVersion" : "2018-10-01",
  "Parameters":{
    "EnvType":{
      "Default":"pre",
      "Type":"String"
    }
  },
  "Conditions": {
    "TestEqualsCond": {"Fn::Equals": ["prod", {"Ref": "EnvType"}]},
    "TestAndCond": {"Fn::And": ["TestEqualsCond", {"Fn::Equals": ["pre", {"Ref": "EnvType"}]}]}
  }
}
```


---


### Fn::Equals
比较两个值是否相等。如果两个值相等，则返回 true；如果不相等，则返回 false。

#### 声明
```
{"Fn::Equals": ["value_1", "value_2"]}
```

#### 参数
**value**：要比较的任意类型的值。

#### 返回值
true 或 false。

### 示例
```
{
  "JDCLOUDTemplateFormatVersion" : "2018-10-01",
  "Parameters":{
    "EnvType":{
      "Default":"pre",
      "Type":"String"
    }
  },
  "Conditions": {
    "TestEqualsCond": {"Fn::Equals": ["prod", {"Ref": "EnvType"}]}
  }
}
```


---

### Fn::If
如果指定的条件计算为 true，则返回一个值；如果指定的条件计算为 false，则返回另一个值。在模板 Resources 和 Outputs 属性值中支持 Fn::If 内部函数。


#### 声明
```
{"Fn::If": ["condition_name", "value_if_true", "value_if_false"]}
```

#### 参数

**condition_name**：Conditions 中条件对应的条件名称。通过条件名称引用条件。

**value_if_true**：当指定的条件计算为 true 时，返回此值。

**value_if_false**：当指定的条件计算为 false 时，返回此值。

#### 返回值

### 示例
```
```


---

### Fn::Not
代表 NOT 运算符。对计算为 false 的条件，返回 true；对计算为 true 的条件，返回 false。

#### 声明
```
{"Fn::Not": "condition"}
```

#### 参数
**condition**：计算为 true 或 false 的条件。

#### 返回值
true 或 false。

### 示例
```
{
  "JDCLOUDTemplateFormatVersion" : "2018-10-01",
  "Parameters":{
    "EnvType":{
      "Default":"pre",
      "Type":"String"
    }
  },
  "Conditions": {
    "TestNotCond": {"Fn::Not": {"Fn::Equals": ["pre", {"Ref": "EnvType"}]}}
  }
}
```

---

### Fn::Or
代表 OR 运算符，最少包含两个条件。如果任意一个指定条件计算为 true，则返回 true；如果所有条件都计算为 false，则返回 false。

#### 声明
```
{"Fn::Or": ["condition", {...}]}
```

#### 参数
**condition**：计算为 true 或 false 的条件。


#### 返回值
true 或 false。

### 示例
```
{
  "JDCLOUDTemplateFormatVersion" : "2018-10-01",
  "Parameters":{
    "EnvType":{
      "Default":"pre",
      "Type":"String"
    }
  },
  "Conditions": {
    "TestEqualsCond": {"Fn::Equals": ["prod", {"Ref": "EnvType"}]},
    "TestOrCond": {"Fn::And": ["TestEqualsCond", {"Fn::Equals": ["pre", {"Ref": "EnvType"}]}]}
  }
}
```


---



### 映射（Mappings）

映射是一个 Key-Value 映射表。在模板的 Resources 和 Outputs 中，可以使用 Fn::FindInMap 内部函数，通过指定 Key 而获取映射表的 Value。

#### 语法

映射由　Key-Value 对组成。其中 Key 和 Value 可以为字符串类型或者数字类型。如果声明多个映射，用逗号分隔开。每个映射的名称不能重复。

```
{
    "Mappings" : {
        "Mapping01" : {
            "Key01" : {
                "Name" : "Value01",
                "Name" : "Value01-1"
            },
            "Key02" : {
                "Name" : "Value02",
                "Name" : "Value02-1"
            },
            "Key03" : {
                "Name" : "Value03",
                "Name" : "Value03-1"
            }
    }
}
```


#### 示例

```
{
    "JDCLOUDTemplateFormatVersion": "2018-10-01",
    "Mappings": {
        "AZInfo": {
            "cn-north-1": {
                "az1": "cn-north-1a",
                "az2": "cn-north-1b"
            },
            "cn-east-1": {
                "az1": "cn-east-1a",
                "az2": "cn-east-1b"
            },
            "cn-east-2": {
                "az1": "cn-east-2a",
                "az2": "cn-east-2b"
            },
            "cn-south-1": {
                "az1": "cn-south-1a",
                "az2": "cn-south-1b"
            }
        }
    },
    "Resources": {
        "MyInstance": {
            "Type": "JDCLOUD::VM::Instance",
            "Properties": {
                "AZ": {
                    "Fn::FindInMap": [
                        "AZInfo",
                        {
                            "Ref": "JDCLOUD::Region"
                        },
                        "az1"
                    ]
                }
            }
        }
    }
}
```


### 条件（Conditions）

根据您在创建或更新堆栈时，指定的输入参数值进行计算。在每个条件中，都可以引用其他条件、参数值或映射。

当您需要重新使用可在不同环境（如测试环境与生产环境）中创建资源的模板时，可能会使用条件。在模板中，您可以添加 EnvironmentType 输入参数，它接受 prod 或 test 作为输入。对于生产环境，您可以包括带特定功能的 Amazon EC2 实例；但对于测试环境，您需要使用更少的功能来节约资金。使用条件，您可以定义对每个环境类型创建哪些资源以及如何配置它们。

#### 语法

每个条件由条件名和条件本身对组成。其中条件名是字符串类型。条件是由 Fn::And、Fn::Or、Fn::Not、或Fn::Equals 定义。在本条件中还可以引用其他条件，多个条件用逗号隔开，每个条件名不能重复。

```
"Conditions" : {
  "Logical ID" : {Intrinsic function}
}
```

#### 示例

以下示例如何关联 Conditions 和 Resources。本示例中，设置根据 EnvType 参数值决定是否给 vm 实例绑定 弹性ip 。

```
{
    "JDCLOUDTemplateFormatVersion": "2018-10-01",
    "Parameters": {
        "EnvType": {
            "Description": "Environment type.",
            "Default": "test",
            "Type": "String",
            "AllowedValues": [
                "prod",
                "test"
            ],
            "ConstraintDescription": "must specify prod or test."
        }
    },
    "Mappings": {
        "AZInfo": {
            "cn-north-1": {
                "az1": "cn-north-1a",
                "az2": "cn-north-1b"
            },
            "cn-east-1": {
                "az1": "cn-east-1a",
                "az2": "cn-east-1b"
            },
            "cn-east-2": {
                "az1": "cn-east-2a",
                "az2": "cn-east-2b"
            },
            "cn-south-1": {
                "az1": "cn-south-1a",
                "az2": "cn-south-1b"
            }
        }
    },
    "Conditions": {
        "CreateProdResources": {
            "Fn::Equals": [
                {
                    "Ref": "EnvType"
                },
                "prod"
            ]
        }
    },
    "Resources": {
        "MyInstance": {
            "Type": "JDCLOUD::VM::Instance",
            "Properties": {
                "AZ": {
                    "Fn::FindInMap": [
                        "AZInfo",
                        {
                            "Ref": "JDCLOUD::Region"
                        },
                        "az1"
                    ]
                }
            }
        },
        "MyElasticIp": {
            "Type": "JDCLOUD::VPC::ElasticIp",
            "Condition": "CreateProdResources",
            "Properties": {
                "ElasticIpSpec": {
                    "BandwidthMbps": "1",
                    "Provider": "bgp"
                }
            }
        },
        "MyAssociateElasticIp": {
            "Type": "JDCLOUD::VPC::AssociateElasticIp",
            "Condition": "CreateProdResources",
            "Properties": {
                "InstanceId": {
                    "Ref": "MyInstance"
                },
                "InstanceType": "vm",
                "ElasticIpId": {
                    "Ref": "MyElasticIp"
                }
            }
        }
    },
    "Outputs": {
        "ElasticIpAddress": {
            "Value": {
                "Fn: : GetAtt": [
                    "MyInstance",
                    "ElasticIpAddress"
                ]
            },
            "Condition": "CreateProdResources"
        }
    }
}
```

# 事件
